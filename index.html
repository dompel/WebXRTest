<!DOCTYPE html>
<html>
<head>
    <title>WebXR Exit Button Example</title>
    <script src="https://unpkg.com/three@0.126.0/build/three.js"></script>
    <style>
        body {
            text-align: center;
            font-family: Arial, sans-serif;
        }
        #startButton {
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Welcome to the Test WebXR Application</h1>
    <button id="startButton" onclick="activateXR()">Start Hello WebXR</button>

    <script>
        let session;
        let camera;
        const raycaster = new THREE.Raycaster();
        const pointer = new THREE.Vector2();

        async function activateXR() {
            if (!navigator.xr) {
                alert("WebXR is not supported on this browser.");
                return;
            }

            const canvas = document.createElement("canvas");
            document.body.appendChild(canvas);
            const gl = canvas.getContext("webgl", { xrCompatible: true });

            const scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera();
            camera.matrixAutoUpdate = false;

            // Create cube for reference
            const materials = [
                new THREE.MeshBasicMaterial({ color: 0xff0000 }),
                new THREE.MeshBasicMaterial({ color: 0x0000ff }),
                new THREE.MeshBasicMaterial({ color: 0x00ff00 }),
                new THREE.MeshBasicMaterial({ color: 0xff00ff }),
                new THREE.MeshBasicMaterial({ color: 0x00ffff }),
                new THREE.MeshBasicMaterial({ color: 0xffff00 })
            ];
            const cube = new THREE.Mesh(new THREE.BoxBufferGeometry(0.2, 0.2, 0.2), materials);
            cube.position.set(0, 0, -1);
            scene.add(cube);

            // Add exit button
            createExitButton(camera);

            const renderer = new THREE.WebGLRenderer({ alpha: true, canvas, context: gl });
            renderer.autoClear = false;

            session = await navigator.xr.requestSession("immersive-ar");
            session.updateRenderState({ baseLayer: new XRWebGLLayer(session, gl) });

            const referenceSpace = await session.requestReferenceSpace("local");

            // XR Render Loop
            const onXRFrame = (time, frame) => {
                session.requestAnimationFrame(onXRFrame);
                gl.bindFramebuffer(gl.FRAMEBUFFER, session.renderState.baseLayer.framebuffer);

                const pose = frame.getViewerPose(referenceSpace);
                if (pose) {
                    const view = pose.views[0];
                    const viewport = session.renderState.baseLayer.getViewport(view);
                    renderer.setSize(viewport.width, viewport.height);

                    camera.matrix.fromArray(view.transform.matrix);
                    camera.projectionMatrix.fromArray(view.projectionMatrix);
                    camera.updateMatrixWorld(true);

                    renderer.clear();
                    renderer.render(scene, camera);
                }
            };
            session.requestAnimationFrame(onXRFrame);
        }

        function exitXR() {
            if (session) {
                session.end();
                console.log("WebXR session ended.");
            }
        }

        function createExitButton(camera) {
            const textureLoader = new THREE.TextureLoader();
            const exitTexture = textureLoader.load("https://upload.wikimedia.org/wikipedia/commons/thumb/7/7d/Red_x.svg/1200px-Red_x.svg.png");

            const exitMaterial = new THREE.MeshBasicMaterial({ 
                map: exitTexture, 
                transparent: true 
            });

            const exitGeometry = new THREE.PlaneGeometry(0.2, 0.2); // Adjust size as needed
            const exitButton3D = new THREE.Mesh(exitGeometry, exitMaterial);

            // Attach button to the camera
            const exitButtonGroup = new THREE.Object3D();
            exitButtonGroup.add(exitButton3D);
            
            // Position the button in the top-right of the user's view
            exitButton3D.position.set(0.4, 0.3, -1); // Adjust for best visibility

            // Ensure the button always faces the user
            exitButton3D.lookAt(0, 0, 0); 

            // Attach to the camera
            camera.add(exitButtonGroup);
            exitButton3D.userData.isExitButton = true;
        }

        function checkExitButtonClick(x, y) {
            pointer.x = (x / window.innerWidth) * 2 - 1;
            pointer.y = -(y / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(pointer, camera);
            const intersects = raycaster.intersectObjects(camera.children, true); // Only check objects inside camera

            for (let i = 0; i < intersects.length; i++) {
                if (intersects[i].object.userData.isExitButton) {
                    console.log("Exit button tapped! Exiting XR...");
                    exitXR();
                    return;
                }
            }
        }

        // Listen for taps
        window.addEventListener("touchstart", (event) => {
            checkExitButtonClick(event.touches[0].clientX, event.touches[0].clientY);
        });

        // Also listen for mouse clicks for debugging
        window.addEventListener("click", (event) => {
            checkExitButtonClick(event.clientX, event.clientY);
        });

    </script>
</body>
</html>
