<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Interactive WebAR Application</title>
    <style>
      body { margin: 0; overflow: hidden; }
      /* Initially hide the AR scene container, the end button, and the survey button */
      #arContainer, #endButton, #surveyButton { display: none; }
    </style>
    <!-- Include A-Frame -->
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <!-- Include AR.js for marker-based AR -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <!-- Include Hammer.js for gesture support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
  </head>
  <body>
    <h1>Welcome to the Interactive WebXR Application</h1>
    <button id="startButton">Start WebXR</button>
    <button id="endButton">End AR Session</button>
    <button id="surveyButton">Zur√ºck zur Umfrage</button>

    <!-- AR container: hidden until the user starts the session -->
    <div id="arContainer">
      <a-scene embedded arjs="sourceType: webcam;">
        <!-- Use the hiro marker to display the AR content -->
        <a-marker preset="hiro">
          <!-- A simple blue cube with an initial position -->
          <a-box id="cube" position="0 0.5 0" material="color: blue;"></a-box>
        </a-marker>
        <a-entity camera></a-entity>
      </a-scene>
    </div>

    <script>
      let arStartTime = 0;

      // Start button: show AR container and initialize gesture controls
      document.getElementById("startButton").onclick = function() {
        document.getElementById("arContainer").style.display = "block";
        document.getElementById("startButton").style.display = "none";
        document.getElementById("endButton").style.display = "inline-block";
        arStartTime = Date.now();

        // Wait for the A-Frame scene to load
        const sceneEl = document.querySelector("a-scene");
        sceneEl.addEventListener("loaded", function () {
          const canvas = sceneEl.canvas;
          const hammer = new Hammer(canvas);

          // Enable gesture recognizers.
          hammer.get("rotate").set({ enable: true });
          hammer.get("pinch").set({ enable: true });
          hammer.get("pan").set({ direction: Hammer.DIRECTION_ALL });

          // Get a reference to the cube.
          const cubeEl = document.getElementById("cube");
          const cubeObj = cubeEl.object3D;
          let initialRotationY = 0;
          let initialScale = 1;
          let startPosition = { x: cubeObj.position.x, z: cubeObj.position.z };

          // Rotation: update the cube's Y-axis rotation.
          hammer.on("rotatemove", function(e) {
            cubeObj.rotation.y = initialRotationY + THREE.Math.degToRad(e.rotation);
          });
          hammer.on("rotateend", function() {
            initialRotationY = cubeObj.rotation.y;
          });

          // Scaling: update the cube's scale uniformly.
          hammer.on("pinchmove", function(e) {
            cubeObj.scale.set(initialScale * e.scale, initialScale * e.scale, initialScale * e.scale);
          });
          hammer.on("pinchend", function() {
            initialScale = cubeObj.scale.x;
          });

          // Translation: update the cube's position along the X and Z axes.
          hammer.on("panstart", function() {
            startPosition = { x: cubeObj.position.x, z: cubeObj.position.z };
          });
          hammer.on("panmove", function(e) {
            const movementFactor = 0.01; // adjust as needed
            cubeObj.position.x = startPosition.x + e.deltaX * movementFactor;
            cubeObj.position.z = startPosition.z + e.deltaY * movementFactor;
          });
        });
      };

      // End button: hide AR scene and show the survey button with elapsed time parameter.
      document.getElementById("endButton").onclick = function() {
        document.getElementById("arContainer").style.display = "none";
        document.getElementById("endButton").style.display = "none";
        const elapsedTime = Math.round((Date.now() - arStartTime) / 1000);
        const surveyButton = document.getElementById("surveyButton");
        surveyButton.style.display = "inline-block";
        surveyButton.onclick = function() {
          window.location.href = `https://ww2.unipark.de/uc/Dominik/1db8/ospe.php?return_tic=tic?a=id&b=1&c=${elapsedTime}`;
        };
      };
    </script>
  </body>
</html>
