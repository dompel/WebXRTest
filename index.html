<!DOCTYPE html>
<html>
<head>
    <title>WebXR Exit Button Example</title>
    <script src="https://unpkg.com/three@0.126.0/build/three.js"></script>
    <style>
        body {
            text-align: center;
            font-family: Arial, sans-serif;
        }
        #startButton {
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Welcome to the WebXR Exit Button Example</h1>
    <button id="startButton" onclick="activateXR()">Start WebXR</button>

    <script>
        let session;
        let camera, scene, exitButton3D, renderer, referenceSpace;
        const raycaster = new THREE.Raycaster();

        async function activateXR() {
            if (!navigator.xr) {
                alert("WebXR is not supported on this browser.");
                return;
            }

            const canvas = document.createElement("canvas");
            document.body.appendChild(canvas);
            const gl = canvas.getContext("webgl", { xrCompatible: true });

            // Initialize scene & camera
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera();
            scene.add(camera);  // Ensure camera is in the scene
            camera.matrixAutoUpdate = false;

            // Create cube for reference
            const materials = [
                new THREE.MeshBasicMaterial({ color: 0xff0000 }),
                new THREE.MeshBasicMaterial({ color: 0x0000ff }),
                new THREE.MeshBasicMaterial({ color: 0x00ff00 }),
                new THREE.MeshBasicMaterial({ color: 0xff00ff }),
                new THREE.MeshBasicMaterial({ color: 0x00ffff }),
                new THREE.MeshBasicMaterial({ color: 0xffff00 })
            ];
            const cube = new THREE.Mesh(new THREE.BoxBufferGeometry(0.2, 0.2, 0.2), materials);
            cube.position.set(0, 0, -1);
            scene.add(cube);

            // Add exit button that follows the camera
            createExitButton(scene, camera);

            renderer = new THREE.WebGLRenderer({ alpha: true, canvas, context: gl });
            renderer.autoClear = false;

            session = await navigator.xr.requestSession("immersive-ar");
            session.updateRenderState({ baseLayer: new XRWebGLLayer(session, gl) });

            referenceSpace = await session.requestReferenceSpace("local");

            // XR Render Loop
            const onXRFrame = (time, frame) => {
                session.requestAnimationFrame(onXRFrame);
                gl.bindFramebuffer(gl.FRAMEBUFFER, session.renderState.baseLayer.framebuffer);

                const pose = frame.getViewerPose(referenceSpace);
                if (pose) {
                    const view = pose.views[0];
                    const viewport = session.renderState.baseLayer.getViewport(view);
                    renderer.setSize(viewport.width, viewport.height);

                    camera.matrix.fromArray(view.transform.matrix);
                    camera.projectionMatrix.fromArray(view.projectionMatrix);
                    camera.updateMatrixWorld(true);

                    // Ensure exit button follows camera
                    if (exitButton3D) {
                        exitButton3D.position.set(
                            camera.position.x + 0.5,  // Slightly to the right
                            camera.position.y + 0.4,  // Slightly above
                            camera.position.z - 1.2   // In front of the camera
                        );
                        exitButton3D.lookAt(camera.position.x, camera.position.y, camera.position.z);
                    }

                    renderer.clear();
                    renderer.render(scene, camera);
                }
            };
            session.requestAnimationFrame(onXRFrame);

            // Listen for WebXR "select" event (finger tap or VR controller trigger)
            session.addEventListener("select", checkExitButtonClick);
        }

        function exitXR() {
            if (session) {
                session.end();
                console.log("WebXR session ended.");
            }
        }

        function createExitButton(scene, camera) {
            const textureLoader = new THREE.TextureLoader();
            const exitTexture = textureLoader.load("https://upload.wikimedia.org/wikipedia/commons/thumb/7/7d/Red_x.svg/1200px-Red_x.svg.png");

            const exitMaterial = new THREE.MeshBasicMaterial({ 
                map: exitTexture, 
                transparent: true 
            });

            const exitGeometry = new THREE.PlaneGeometry(0.2, 0.2);
            exitButton3D = new THREE.Mesh(exitGeometry, exitMaterial);

            // Position it in the top-right of the user's view
            exitButton3D.position.set(0.5, 0.4, -1.2);

            // Ensure the button always faces the user
            exitButton3D.lookAt(camera.position.x, camera.position.y, camera.position.z);

            exitButton3D.userData.isExitButton = true;
            scene.add(exitButton3D);

            console.log("Exit button added to scene:", exitButton3D);
        }

        function checkExitButtonClick(event) {
            if (!session) return;

            // Get the active input source (finger tap, controller, etc.)
            const inputSources = session.inputSources;
            if (inputSources.length === 0) return; // No input detected

            const inputSource = inputSources[0]; // Use the first input source
            if (!inputSource || !inputSource.targetRaySpace) return;

            // Use XR Raycaster to check intersection with the exit button
            session.requestAnimationFrame((time, frame) => {
                if (!referenceSpace) return;
                const pose = frame.getPose(inputSource.targetRaySpace, referenceSpace);
                if (!pose) return;

                const rayOrigin = new THREE.Vector3(
                    pose.transform.position.x,
                    pose.transform.position.y,
                    pose.transform.position.z
                );

                const rayDirection = new THREE.Vector3(0, 0, -1); // Assuming it's pointing forward

                raycaster.set(rayOrigin, rayDirection);
                const intersects = raycaster.intersectObjects(scene.children, true);

                for (let i = 0; i < intersects.length; i++) {
                    if (intersects[i].object.userData.isExitButton) {
                        console.log("Exit button tapped! Exiting XR...");
                        exitXR();
                        return;
                    }
                }
            });
        }
    </script>
</body>
</html>
