<!DOCTYPE html>
<html>
<head>
    <title>Web XR Example</title>
    <script src="https://unpkg.com/three@0.126.0/build/three.js"></script>
    <style>
        body {
            text-align: center;
            font-family: Arial, sans-serif;
        }
        #startButton, #surveyButton {
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            margin-top: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <h1>Welcome to the Test WebXR Application</h1>
    <button id="startButton">Start Hello WebXR</button>
    <button id="surveyButton">Zur√ºck zur Umfrage</button>

    <script>
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        let arStartTime;
        let arActive = false;
        let mediaRecorder;
        let recordedChunks = [];

        const id = getQueryParam("ID") || "";
        const tic = getQueryParam("tic") || "";
        const startButton = document.getElementById("startButton");
        const surveyButton = document.getElementById("surveyButton");

        startButton.style.display = "inline-block";

        startButton.onclick = async function () {
            arStartTime = Date.now();
            arActive = true;

            // WebXR Initialisierung
            const canvas = document.createElement("canvas");
            document.body.appendChild(canvas);
            const gl = canvas.getContext("webgl", { xrCompatible: true });

            // WebGL Recording
            const stream = canvas.captureStream(30); // 30 FPS
            mediaRecorder = new MediaRecorder(stream, { mimeType: "video/webm" });
            recordedChunks = [];

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: "video/webm" });
                console.log("Recording completed, uploading to GitHub...");
                uploadToGitHub(blob);
            };

            mediaRecorder.start();
            console.log("Recording started...");

            const scene = new THREE.Scene();
            const materials = [
                new THREE.MeshBasicMaterial({ color: 0xff0000 }),
                new THREE.MeshBasicMaterial({ color: 0x0000ff }),
                new THREE.MeshBasicMaterial({ color: 0x00ff00 }),
                new THREE.MeshBasicMaterial({ color: 0xff00ff }),
                new THREE.MeshBasicMaterial({ color: 0x00ffff }),
                new THREE.MeshBasicMaterial({ color: 0xffff00 })
            ];
            const cube = new THREE.Mesh(new THREE.BoxBufferGeometry(0.2, 0.2, 0.2), materials);
            cube.position.set(0, 0, -1);
            scene.add(cube);

            const renderer = new THREE.WebGLRenderer({ alpha: true, preserveDrawingBuffer: true, canvas: canvas, context: gl });
            renderer.autoClear = false;
            const camera = new THREE.PerspectiveCamera();
            camera.matrixAutoUpdate = false;

            if (!navigator.xr) {
                alert("WebXR is not supported on this browser.");
                return;
            }

            const session = await navigator.xr.requestSession("immersive-ar");
            session.updateRenderState({ baseLayer: new XRWebGLLayer(session, gl) });
            const referenceSpace = await session.requestReferenceSpace('local');

            const onXRFrame = (time, frame) => {
                session.requestAnimationFrame(onXRFrame);
                gl.bindFramebuffer(gl.FRAMEBUFFER, session.renderState.baseLayer.framebuffer);
                const pose = frame.getViewerPose(referenceSpace);
                if (pose) {
                    const view = pose.views[0];
                    const viewport = session.renderState.baseLayer.getViewport(view);
                    renderer.setSize(viewport.width, viewport.height);
                    camera.matrix.fromArray(view.transform.matrix);
                    camera.projectionMatrix.fromArray(view.projectionMatrix);
                    camera.updateMatrixWorld(true);
                    renderer.clear();
                    renderer.render(scene, camera);
                }
            };

            session.requestAnimationFrame(onXRFrame);

            session.addEventListener("end", () => {
                arActive = false;
                const elapsedTime = Math.round((Date.now() - arStartTime) / 1000);
                const surveyUrl = `https://ww2.unipark.de/uc/Dominik/1db8/ospe.php?return_tic=${tic}&c_0001=1&c_0002=${elapsedTime}`;

                mediaRecorder.stop(); // Stop recording

                surveyButton.style.display = "inline-block";
                surveyButton.onclick = () => window.location.href = surveyUrl;
            });
        };

        async function uploadToGitHub(blob) {
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = async () => {
                const base64data = reader.result.split(",")[1];

                // üî¥ REPLACE WITH YOUR REPO & TEMPORARY TOKEN
                const GITHUB_TOKEN = "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";
                const GITHUB_REPO = "dompel/WebXRTest"; // Replace with your actual repo
                const fileName = `WebAR_Recordings/recording_${Date.now()}.webm`;

                const apiUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/${fileName}`;

                try {
                    const response = await fetch(apiUrl, {
                        method: "PUT",
                        headers: {
                            "Authorization": `token ${GITHUB_TOKEN}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            message: `Added WebAR Recording ${new Date().toISOString()}`,
                            content: base64data
                        })
                    });

                    if (response.ok) {
                        console.log("‚úÖ Upload successful:", (await response.json()).content.html_url);
                    } else {
                        console.error("‚ùå Upload failed:", await response.text());
                    }
                } catch (error) {
                    console.error("‚ö†Ô∏è Error uploading to GitHub:", error);
                }
            };
        }
    </script>
</body>
</html>
