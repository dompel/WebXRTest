<!DOCTYPE html>
<html>
  <head>
    <title>WebXR Interactive Cube (Mobile Support)</title>
    <script src="https://unpkg.com/three@0.126.0/build/three.js"></script>
    <script src="https://unpkg.com/three@0.126.0/examples/jsm/webxr/XRControllerModelFactory.js"></script>
    <script src="https://unpkg.com/three@0.126.0/examples/jsm/webxr/XRHandModelFactory.js"></script>
    <style>
      body {
        text-align: center;
        font-family: Arial, sans-serif;
        touch-action: none;
      }
      #startButton, #surveyButton {
        padding: 10px 20px;
        font-size: 18px;
        cursor: pointer;
        background-color: #007BFF;
        color: white;
        border: none;
        border-radius: 5px;
        margin-top: 20px;
        display: none;
      }
    </style>
  </head>
  <body>
    <h1>Welcome to the Interactive WebXR Application</h1>
    <button id="startButton">Start WebXR</button>
    <button id="surveyButton">Zur√ºck zur Umfrage</button>
    
    <script>
      let arStartTime, arActive = false;
      let cube, scene, renderer, camera, session;
      let isDragging = false, previousTouch;

      document.getElementById("startButton").style.display = "inline-block";
      document.getElementById("startButton").onclick = async function () {
        arStartTime = Date.now();
        arActive = true;
        
        const canvas = document.createElement("canvas");
        document.body.appendChild(canvas);
        const gl = canvas.getContext("webgl", { xrCompatible: true });
        
        scene = new THREE.Scene();
        renderer = new THREE.WebGLRenderer({ alpha: true, preserveDrawingBuffer: true, canvas: canvas, context: gl });
        renderer.autoClear = false;
        renderer.xr.enabled = true;
        
        camera = new THREE.PerspectiveCamera();
        camera.matrixAutoUpdate = false;
        
        const materials = [
          new THREE.MeshBasicMaterial({ color: 0xff0000 }),
          new THREE.MeshBasicMaterial({ color: 0x0000ff }),
          new THREE.MeshBasicMaterial({ color: 0x00ff00 }),
          new THREE.MeshBasicMaterial({ color: 0xff00ff }),
          new THREE.MeshBasicMaterial({ color: 0x00ffff }),
          new THREE.MeshBasicMaterial({ color: 0xffff00 })
        ];
        cube = new THREE.Mesh(new THREE.BoxBufferGeometry(0.2, 0.2, 0.2), materials);
        cube.position.set(0, 0, -1);
        scene.add(cube);
        
        if (!navigator.xr) {
          alert("WebXR is not supported on this browser.");
          return;
        }
        
        session = await navigator.xr.requestSession("immersive-ar", { requiredFeatures: ["local-floor", "hand-tracking"] });
        session.updateRenderState({ baseLayer: new XRWebGLLayer(session, gl) });
        const referenceSpace = await session.requestReferenceSpace("local-floor");
        
        renderer.xr.setReferenceSpaceType("local-floor");
        renderer.xr.setSession(session);
        
        const onXRFrame = (time, frame) => {
          if (!session) return;
          session.requestAnimationFrame(onXRFrame);
          gl.bindFramebuffer(gl.FRAMEBUFFER, session.renderState.baseLayer.framebuffer);
          
          const pose = frame.getViewerPose(referenceSpace);
          if (pose) {
            const view = pose.views[0];
            const viewport = session.renderState.baseLayer.getViewport(view);
            renderer.setSize(viewport.width, viewport.height);
            camera.matrix.fromArray(view.transform.matrix);
            camera.projectionMatrix.fromArray(view.projectionMatrix);
            camera.updateMatrixWorld(true);
            renderer.clear();
            renderer.render(scene, camera);
          }
        };
        
        session.requestAnimationFrame(onXRFrame);
        
        session.addEventListener("end", () => {
          arActive = false;
          session = null;
          const elapsedTime = Math.round((Date.now() - arStartTime) / 1000);
          document.getElementById("surveyButton").style.display = "inline-block";
          document.getElementById("surveyButton").onclick = () => {
            window.location.href = `https://ww2.unipark.de/uc/Dominik/1db8/ospe.php?return_tic=tic?a=id&b=1&c=${elapsedTime}`;
          };
        });
      };
      
      document.addEventListener("touchstart", (event) => {
        if (!arActive || !cube) return;
        if (event.touches.length === 1) {
          isDragging = true;
          previousTouch = event.touches[0];
        }
      });

      document.addEventListener("touchmove", (event) => {
        if (!arActive || !isDragging || event.touches.length !== 1) return;
        const touch = event.touches[0];
        const deltaX = touch.clientX - previousTouch.clientX;
        const deltaY = touch.clientY - previousTouch.clientY;
        
        cube.position.x += deltaX * 0.001;
        cube.position.y -= deltaY * 0.001;
        previousTouch = touch;
      });

      document.addEventListener("touchend", () => {
        isDragging = false;
      });
    </script>
  </body>
</html>
